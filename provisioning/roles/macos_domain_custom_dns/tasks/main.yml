---

- name: Validate domain configuration
  ansible.builtin.assert:
    that:
      - item.nameservers is defined
      - item.nameservers | length > 0
    fail_msg: "Domain '{{ item.domain }}' must have at least one nameserver configured"
    quiet: true
  loop: "{{ macos_domain_custom_dns_domains }}"

- name: Ensure /etc/resolver directory exists
  ansible.builtin.file:
    path: /etc/resolver
    state: directory
    mode: '0755'
  become: true

- name: Configure custom DNS resolvers for domains
  ansible.builtin.template:
    src: resolver.j2
    dest: "/etc/resolver/{{ item.domain }}"
    mode: '0644'
  loop: "{{ macos_domain_custom_dns_domains }}"
  become: true
  notify: Flush DNS cache

- name: List configured resolver files
  ansible.builtin.find:
    paths: /etc/resolver
    file_type: file
  register: macos_domain_custom_dns_existing_files
  become: true

- name: Remove resolver files for domains not in configuration
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ macos_domain_custom_dns_existing_files.files }}"
  when: item.path | basename not in macos_domain_custom_dns_domains | map(attribute='domain') | list
  become: true
  notify: Flush DNS cache
